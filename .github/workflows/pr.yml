name: CI
on:
  pull_request:
    branches:
      - master
      - staging
      - demo
      - preview/*
      - release/*
    paths-ignore:
      - '**.md'
      - 'docs/**'
  push:
    branches:
      - master
      - staging
      - demo
      - preview/*
      - release/*
    paths-ignore:
      - '**.md'
      - 'docs/**'
    #TODO: currently release is done manually, we don't want to run this pipeline on released version, to avoid accidental pushes
    tags-ignore:
      - '**'
env:
  #we use this variable in ciRunSbt.sh
  #NOTE: for publishing we use different settings, we don't use ciRunSbt.sh there
  CROSS_BUILD: ${{ github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/heads/preview') || startsWith(github.ref, 'refs/heads/release') }}

jobs:
  benchmarks:
    name: Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Scala
        uses: olafurpg/setup-scala@v10
        with:
          java-version: "openjdk@1.11"
      - name: Run benchmarks
        run: sbt "benchmarks/jmh:run -i 8 -wi 3 -f1 -t1 .*interpreter.*"

#  setup:
#    runs-on: ubuntu-latest
#    outputs:
#      fe_changes_count: ${{ steps.filter.outputs.fe_changes_count }}
#      all_changes_count: ${{ steps.filter.outputs.all_changes_count }}
#      git_source_branch: ${{ steps.variables.outputs.git_source_branch }}
#      nk_snapshot_version: ${{ steps.variables.outputs.nk_snapshot_version }}
#    steps:
#      - uses: actions/checkout@v2
#        with:
#          fetch-depth: 100
#      - uses: dorny/paths-filter@v2
#        id: filter
#        with:
#          list-files: 'csv'
#          filters: |
#            fe_changes:
#              - 'ui/client/**'
#            all_changes:
#              - '**'
#      - name: Define variables
#        id: variables
#        shell: bash
#        run: |
#          GIT_SOURCE_BRANCH=`([ "${GITHUB_HEAD_REF}" != "" ] && echo "${GITHUB_HEAD_REF}" || echo "${GITHUB_REF}") | sed 's/refs\/heads\///g'`
#          SANITIZED_BRANCH=`echo ${GIT_SOURCE_BRANCH} | sed 's/[^a-zA-Z0-9._-]/\_/g' | awk '{print tolower($0)}'`
#          VERSION_SUFFIX="-$SANITIZED_BRANCH-$(date -I)-$GITHUB_RUN_NUMBER-$GITHUB_SHA"
#          NK_SNAPSHOT_VERSION=`cat version.sbt | sed -e 's/.*:= *"//' -e 's/" *//' | sed "s/-SNAPSHOT/${VERSION_SUFFIX}-SNAPSHOT/"`
#          echo "::set-output name=git_source_branch::$GIT_SOURCE_BRANCH"
#          echo "::set-output name=nk_snapshot_version::$NK_SNAPSHOT_VERSION"
#
#  build:
#    name: Build
#    runs-on: ubuntu-latest
#    needs: [ setup ]
#    env:
#      # We can't just use conditional jobs mechanism ('if' directive) because 'dockerTest' job depends on this one
#      shouldPerformBackendBuild: ${{ needs.setup.outputs.all_changes_count > needs.setup.outputs.fe_changes_count || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/demo' || startsWith(github.ref, 'refs/heads/preview') || startsWith(github.ref, 'refs/heads/release') }}
#    steps:
#      - name: Cancel previous runs
#        if: ${{ env.shouldPerformBackendBuild == 'true' }}
#        uses: styfle/cancel-workflow-action@0.8.0
#        with:
#          access_token: ${{ secrets.GITHUB_TOKEN }}
#      - uses: actions/checkout@v2
#        if: ${{ env.shouldPerformBackendBuild == 'true' }}
#      - name: Cache ivy packages
#        if: ${{ env.shouldPerformBackendBuild == 'true' }}
#        uses: actions/cache@v2
#        with:
#          path: |
#            ~/.ivy2/cache
#            ~/.sbt
#          key: ${{ runner.os }}-ivy2-${{ hashFiles('**/*.sbt') }}
#          restore-keys: ${{ runner.os }}-sbt
#      - uses: olafurpg/setup-scala@v10
#        if: ${{ env.shouldPerformBackendBuild == 'true' }}
#        with:
#          java-version: "openjdk@1.11"
#      - name: Build
#        if: ${{ env.shouldPerformBackendBuild == 'true' }}
#        shell: bash
#        run: ./ciRunSbt.sh compile
#      - name: Tar artifacts
#        if: ${{ env.shouldPerformBackendBuild == 'true' }}
#        shell: bash
#        run:  find . -wholename "**/target/**/*" -printf '%P\0' | tar --null -C '.' --files-from=- -czf 'target.tgz'
#      - name: Store target
#        if: ${{ env.shouldPerformBackendBuild == 'true' }}
#        uses: actions/upload-artifact@v2
#        with:
#          name: build-target
#          path: target.tgz

#  build-fe:
#    name: BuildFrontend
#    runs-on: ubuntu-latest
#    needs: [ setup ]
#    env:
#      NUSSKNACKER_VERSION: ${{ needs.setup.outputs.nk_snapshot_version }}
#    steps:
#      - name: Cancel previous runs
#        uses: styfle/cancel-workflow-action@0.8.0
#        with:
#          access_token: ${{ secrets.GITHUB_TOKEN }}
#      - uses: actions/checkout@v2
#      - name: Cache npm
#        id: cache-npm
#        uses: actions/cache@v2
#        with:
#          path: |
#            **/node_modules
#            ~/.cache/Cypress
#          key: ${{ runner.os }}-${{ hashFiles('ui/client/package-lock.json', 'ui/client/.nvmrc') }}
#      - name: Get Node.js version
#        if: steps.cache-npm.outputs.cache-hit != 'true'
#        id: nvm
#        run: echo ::set-output name=NODE_VERSION::$(cat ui/client/.nvmrc)
#      - name: Use Node.js ${{ matrix.node-version }}
#        if: steps.cache-npm.outputs.cache-hit != 'true'
#        uses: actions/setup-node@v2
#        with:
#          node-version: ${{ steps.nvm.outputs.NODE_VERSION }}
#      - name: Setup npm
#        if: steps.cache-npm.outputs.cache-hit != 'true'
#        run: (cd ui/client; npm ci --prefer-offline --no-audit)
#      - name: Build FE
#        run: (cd ui/client; npm run build)
#      - name: Tar fe artifacts
#        shell: bash
#        run:  tar -czf 'fe-dist.tgz' ui/client/dist
#      - name: Store dist
#        uses: actions/upload-artifact@v2
#        with:
#          name: build-fe-dist
#          path: fe-dist.tgz
#
#  tests:
#    name: Tests
#    runs-on: ubuntu-latest
#    needs: [ build, setup ]
#    if: ${{ needs.setup.outputs.all_changes_count > needs.setup.outputs.fe_changes_count || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/demo' || startsWith(github.ref, 'refs/heads/preview') || startsWith(github.ref, 'refs/heads/release') }}
#    steps:
#      - name: Cancel previous runs
#        uses: styfle/cancel-workflow-action@0.8.0
#        with:
#          access_token: ${{ secrets.GITHUB_TOKEN }}
#      - uses: actions/checkout@v2
#      - uses: olafurpg/setup-scala@v10
#        with:
#          java-version: "openjdk@1.11"
#      - uses: actions/download-artifact@v2
#        with:
#          name: build-target
#      - name: Untar artifacts
#        shell: bash
#        run:  tar xfz target.tgz
#      - name: Cache ivy packages
#        uses: actions/cache@v2
#        with:
#          path: |
#            ~/.ivy2/cache
#            ~/.sbt
#          key: ${{ runner.os }}-ivy2-${{ hashFiles('**/*.sbt') }}
#          restore-keys: ${{ runner.os }}-sbt
#      - name: Backend tests with coverage
#        shell: bash
#        if: ${{ github.ref == 'refs/heads/staging' }}
#        run: ./ciRunSbt.sh coverage test coverageReport
#      - name: Backend tests without coverage
#        shell: bash
#        if: ${{ github.ref != 'refs/heads/staging' }}
#        run: ./ciRunSbt.sh test
#      - name: Upload Coverage data to Coveralls
#        shell: bash
#        if: ${{ github.ref == 'refs/heads/staging' }}
#        run: ./ciRunSbt.sh coverageAggregate coveralls
#        env:
#          COVERALLS_REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#
#  crossCompile:
#    name: CrossCompile
#    runs-on: ubuntu-latest
#    needs: [ build, setup ]
#    if: ${{ needs.setup.outputs.all_changes_count > needs.setup.outputs.fe_changes_count || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/demo' || startsWith(github.ref, 'refs/heads/preview') || startsWith(github.ref, 'refs/heads/release') }}
#    steps:
#      - name: Cancel previous runs
#        uses: styfle/cancel-workflow-action@0.8.0
#        with:
#          access_token: ${{ secrets.GITHUB_TOKEN }}
#      - uses: actions/checkout@v2
#      - name: Cache ivy packages
#        uses: actions/cache@v2
#        with:
#          path: |
#            ~/.ivy2/cache
#            ~/.sbt
#          key: ${{ runner.os }}-ivy2-${{ hashFiles('**/*.sbt') }}
#          restore-keys: ${{ runner.os }}-sbt
#      - uses: olafurpg/setup-scala@v10
#        with:
#          java-version: "openjdk@1.11"
#      - uses: actions/download-artifact@v2
#        with:
#          name: build-target
#      - name: Untar artifacts
#        shell: bash
#        run:  tar xfz target.tgz
#      - name: Compile
#        shell: bash
#        run: CROSS_BUILD=true ./ciRunSbt.sh compile:compile test:compile
#  integrationTests:
#    name: IntegrationTests
#    needs: [ build, setup ]
#    if: ${{ needs.setup.outputs.all_changes_count > needs.setup.outputs.fe_changes_count || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/demo' || startsWith(github.ref, 'refs/heads/preview') || startsWith(github.ref, 'refs/heads/release') }}
#    runs-on: ubuntu-latest
#    steps:
#      - name: Cancel previous runs
#        uses: styfle/cancel-workflow-action@0.8.0
#        with:
#          access_token: ${{ secrets.GITHUB_TOKEN }}
#      - uses: actions/checkout@v2
#      - name: Cache ivy packages
#        uses: actions/cache@v2
#        with:
#          path: |
#            ~/.ivy2/cache
#            ~/.sbt
#          key: ${{ runner.os }}-ivy2-${{ hashFiles('**/*.sbt') }}
#          restore-keys: ${{ runner.os }}-sbt
#      - uses: olafurpg/setup-scala@v10
#        with:
#          java-version: "openjdk@1.11"
#      - uses: actions/download-artifact@v2
#        with:
#          name: build-target
#      - name: Untar artifacts
#        shell: bash
#        run:  tar xfz target.tgz
#      - name: Integration tests
#        shell: bash
#        run: ./ciRunSbt.sh flinkDeploymentManager/it:test engineStandalone/it:test processReports/it:test security/it:test
#  slowTests:
#    name: Slow tests
#    runs-on: ubuntu-latest
#    needs: [ build, setup ]
#    if: ${{ needs.setup.outputs.all_changes_count > needs.setup.outputs.fe_changes_count || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/demo' || startsWith(github.ref, 'refs/heads/preview') || startsWith(github.ref, 'refs/heads/release') }}
#    steps:
#      - name: Cancel previous runs
#        uses: styfle/cancel-workflow-action@0.8.0
#        with:
#          access_token: ${{ secrets.GITHUB_TOKEN }}
#      - uses: actions/checkout@v2
#      - name: Cache ivy packages
#        uses: actions/cache@v2
#        with:
#          path: |
#            ~/.ivy2/cache
#            ~/.sbt
#          key: ${{ runner.os }}-ivy2-${{ hashFiles('**/*.sbt') }}
#          restore-keys: ${{ runner.os }}-sbt
#      - uses: olafurpg/setup-scala@v10
#        with:
#          java-version: "openjdk@1.11"
#      - uses: actions/download-artifact@v2
#        with:
#          name: build-target
#      - name: Untar artifacts
#        shell: bash
#        run:  tar xfz target.tgz
#      - name: Slow tests
#        shell: bash
#        run: ./ciRunSbt.sh ui/slow:test
#
#  frontendTests:
#    name: FrontendTests
#    runs-on: ubuntu-latest
#    needs: [ setup ]
#    env:
#      # We can't just use conditional jobs mechanism ('if' directive) because 'publish' job depends on this one.
#      shouldPerformFrontendTests: ${{ needs.setup.outputs.fe_changes_count > 0 }}
#    steps:
#      - name: Cancel previous runs
#        if: ${{ env.shouldPerformFrontendTests == 'true' }}
#        uses: styfle/cancel-workflow-action@0.8.0
#        with:
#          access_token: ${{ secrets.GITHUB_TOKEN }}
#      - uses: actions/checkout@v2
#        if: ${{ env.shouldPerformFrontendTests == 'true' }}
#      - name: Cache npm
#        id: cache-npm
#        if: ${{ env.shouldPerformFrontendTests == 'true' }}
#        uses: actions/cache@v2
#        with:
#          path: |
#            **/node_modules
#            ~/.cache/Cypress
#          key: ${{ runner.os }}-${{ hashFiles('ui/client/package-lock.json', 'ui/client/.nvmrc') }}
#      - name: Get Node.js version
#        if: ${{ env.shouldPerformFrontendTests == 'true' && steps.cache-npm.outputs.cache-hit != 'true' }}
#        id: nvm
#        run: echo ::set-output name=NODE_VERSION::$(cat ui/client/.nvmrc)
#      - name: Use Node.js ${{ matrix.node-version && steps.cache-npm.outputs.cache-hit != 'true' }}
#        if: ${{ env.shouldPerformFrontendTests == 'true' && steps.cache-npm.outputs.cache-hit != 'true' }}
#        uses: actions/setup-node@v2
#        with:
#          node-version: ${{ steps.nvm.outputs.NODE_VERSION }}
#      - name: Setup npm
#        if: ${{ env.shouldPerformFrontendTests == 'true' && steps.cache-npm.outputs.cache-hit != 'true' }}
#        run: (cd ui/client; npm ci --prefer-offline --no-audit)
#      - name: Test FE
#        if: ${{ env.shouldPerformFrontendTests == 'true' }}
#        run: (cd ui/client; npm run test:unit)
#
#  dockerTest:
#    name: Docker based tests
#    runs-on: ubuntu-latest
#    needs: [ build, build-fe, setup ]
#    env:
#      # We skip docker build for fe-only changes. Would be more clean to split this step into two steps: build image and run tests
#      # e.g. by using ishworkh/docker-image-artifact-upload/download but it caused ~3min overhead for the whole pipeline so we
#      # have this conditional logic in this step. We force building images on our "special" branches because run between merges
#      # could cause that cypress tests will be run at stale image (because of cancel-workflow-action).
#      shouldBuildImage: ${{ needs.setup.outputs.all_changes_count > needs.setup.outputs.fe_changes_count || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/demo' || startsWith(github.ref, 'refs/heads/preview') || startsWith(github.ref, 'refs/heads/release') }}
#      GIT_SOURCE_BRANCH: ${{ needs.setup.outputs.git_source_branch }}
#    steps:
#      - name: Cancel previous runs
#        uses: styfle/cancel-workflow-action@0.8.0
#        with:
#          access_token: ${{ secrets.GITHUB_TOKEN }}
#      - uses: actions/checkout@v2
#      - name: Cache npm
#        id: cache-npm
#        uses: actions/cache@v2
#        with:
#          path: |
#            **/node_modules
#            ~/.cache/Cypress
#          key: ${{ runner.os }}-${{ hashFiles('ui/client/package-lock.json', 'ui/client/.nvmrc') }}
#      - name: Get Node.js version
#        if: steps.cache-npm.outputs.cache-hit != 'true'
#        id: nvm
#        run: echo ::set-output name=NODE_VERSION::$(cat ui/client/.nvmrc)
#      - name: Use Node.js ${{ matrix.node-version }}
#        if: steps.cache-npm.outputs.cache-hit != 'true'
#        uses: actions/setup-node@v2
#        with:
#          node-version: ${{ steps.nvm.outputs.NODE_VERSION }}
#      - name: Setup npm
#        if: steps.cache-npm.outputs.cache-hit != 'true'
#        run: (cd ui/client; npm ci --prefer-offline --no-audit)
#      - name: Cache ivy packages
#        if: ${{ env.shouldBuildImage == 'true' }}
#        uses: actions/cache@v2
#        with:
#          path: |
#            ~/.ivy2/cache
#            ~/.sbt
#          key: ${{ runner.os }}-ivy2-${{ hashFiles('**/*.sbt') }}
#          restore-keys: ${{ runner.os }}-sbt
#      - uses: olafurpg/setup-scala@v10
#        if: ${{ env.shouldBuildImage == 'true' }}
#        with:
#          java-version: "openjdk@1.11"
#      - uses: actions/download-artifact@v2
#        if: ${{ env.shouldBuildImage == 'true' }}
#        with:
#          name: build-target
#      - name: Untar artifacts
#        if: ${{ env.shouldBuildImage == 'true' }}
#        shell: bash
#        run:  tar xfz target.tgz
#      - uses: actions/download-artifact@v2
#        with:
#          name: build-fe-dist
#      - name: Untar fe artifacts
#        shell: bash
#        run:  tar xfz fe-dist.tgz
#      - name: set version
#        if: ${{ env.shouldBuildImage == 'true' }}
#        shell: bash
#        run: echo "NUSSKNACKER_VERSION=${{ needs.setup.outputs.nk_snapshot_version }}" >> $GITHUB_ENV
#      - name: Prepare docker
#        if: ${{ env.shouldBuildImage == 'true' }}
#        env:
#          addDevModel: true
#        shell: bash
#        #Doc generation is rather costly, we don't want it in test image creation
#        run: sbt "set version in ThisBuild := \"$NUSSKNACKER_VERSION\"; set publishArtifact in (ThisBuild, packageDoc) := false; set sources in (Compile,doc) := Seq.empty" dist/docker:publishLocal
#      - name: FE tests e2e on build docker image
#        if: ${{ env.shouldBuildImage == 'true' }}
#        env:
#          CYPRESS_BASE_URL: http://localhost:8080
#          DOCKER_PULL_OPTION: never
#        shell: bash
#        run: |
#          cd ui/client
#          npx start-server-and-test backend:docker 8080 test:e2e
#      - name: Determine docker tag version to use
#        if: ${{ env.shouldBuildImage == 'false' }}
#        shell: bash
#        run: |
#          # Take a look at build.sbt commonDockerSettings to see how this tag is determined. Thanks to fact that we publish all changes pushed to our "special" branches it should work quite correctly.
#          NK_REF_VERSION=`[ "${GITHUB_REF}" != "" ] && echo "${GITHUB_REF}" | sed -e 's/refs\/heads\///g' -e 's/[^a-zA-Z0-9._-]/\_/g' -e 's/$/-latest/' | xargs -I VER sh -c 'docker pull touk/nussknacker:VER > /dev/null && echo VER || echo ""'`
#          NK_BASE_REF_VERSION=`[ "${NK_REF_VERSION}" != "" ] && echo "${NK_REF_VERSION}" || [ "${GITHUB_BASE_REF}" != "" ] && echo "${GITHUB_BASE_REF}" | sed -e 's/refs\/heads\///g' -e 's/[^a-zA-Z0-9._-]/\_/g' -e 's/$/-latest/' | xargs -I VER sh -c 'docker pull touk/nussknacker:VER > /dev/null && echo VER || echo ""'`
#          echo "NUSSKNACKER_VERSION=`[ \"${NK_BASE_REF_VERSION}\" != \"\" ] && echo \"${NK_BASE_REF_VERSION}\" || echo staging-latest`" >> $GITHUB_ENV
#      - name: FE tests e2e on pulled image
#        if: ${{ env.shouldBuildImage == 'false' }}
#        shell: bash
#        # TODO: test production build instead of development
#        run: |
#          cd ui/client
#          npx start-server-and-test backend:docker 8080 start-prod 3000 test:e2e
#      - name: Store test results
#        if: always()
#        uses: actions/upload-artifact@v2
#        with:
#          name: e2e-test-results
#          path: |
#            ui/client/cypress/**/__image_snapshots__/
#            ui/client/cypress/screenshots/
#            ui/client/cypress/videos/
#          if-no-files-found: ignore
#
#  #TODO: extract to different workflow?
#  publish:
#    runs-on: ubuntu-latest
#    needs: [build, build-fe, setup, tests, crossCompile, integrationTests, slowTests, frontendTests, dockerTest]
#    #TODO: should we publish everything on all those branches?
#    if: ${{ github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/demo' || startsWith(github.ref, 'refs/heads/preview') || startsWith(github.ref, 'refs/heads/release') }}
#    env:
#      #TODO: shouldn't be needed...
#      nexusUrl: https://oss.sonatype.org/content/repositories/snapshots
#      nexusUser: ${{ secrets.SONATYPE_USER }}
#      nexusPassword: ${{ secrets.SONATYPE_PASSWORD }}
#      # We add dev model to staging because it is used in dev used on this environment, but we also add it for other branches for purpose of cypress tests
#      addDevModel: true
#      NUSSKNACKER_VERSION: ${{ needs.setup.outputs.nk_snapshot_version }}
#      GIT_SOURCE_BRANCH: ${{ needs.setup.outputs.git_source_branch }}
#    steps:
#      - name: Cancel previous runs
#        uses: styfle/cancel-workflow-action@0.8.0
#        with:
#          access_token: ${{ secrets.GITHUB_TOKEN }}
#      - uses: actions/checkout@v2
#      - name: Cache ivy packages
#        uses: actions/cache@v2
#        with:
#          path: |
#            ~/.ivy2/cache
#            ~/.sbt
#          key: ${{ runner.os }}-ivy2-${{ hashFiles('**/*.sbt') }}
#          restore-keys: ${{ runner.os }}-sbt
#      - uses: olafurpg/setup-scala@v10
#        with:
#          java-version: "openjdk@1.11"
#      - uses: actions/download-artifact@v2
#        with:
#          name: build-target
#      - name: Untar artifacts
#        shell: bash
#        run:  tar xfz target.tgz
#      - uses: actions/download-artifact@v2
#        with:
#          name: build-fe-dist
#      - name: Untar fe artifacts
#        shell: bash
#        run:  tar xfz fe-dist.tgz
#      - name: Login to Docker Hub
#        uses: docker/login-action@v1
#        with:
#          username: ${{ secrets.DOCKERHUB_USER }}
#          password: ${{ secrets.DOCKERHUB_TOKEN }}
#      - name: Publish with scaladocs
#        if: ${{ github.ref == 'refs/heads/staging' }}
#        shell: bash
#        #TODO: handle version better, do we want to publish docker image for older scala versions? If so, how should it be tagged?
#        run: sbt -J-Xms1000M -J-Xmx1000M "set version in ThisBuild := \"$NUSSKNACKER_VERSION\"" +publish dist/docker:publish standaloneApp/docker:publish
#      - name: Publish without scaladocs
#        if: ${{ github.ref != 'refs/heads/staging' }}
#        shell: bash
#        #TODO: handle version better, do we want to publish docker image for older scala versions? If so, how should it be tagged?
#        run: sbt -J-Xms1000M -J-Xmx1000M "set version in ThisBuild := \"$NUSSKNACKER_VERSION\"; set publishArtifact in (ThisBuild, packageDoc) := false; set sources in (Compile,doc) := Seq.empty" +publish dist/docker:publish standaloneApp/docker:publish
